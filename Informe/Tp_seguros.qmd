```{r}
# Librerias
library(dplyr)
library(readxl)
library(ggplot2)
library(lubridate)
library(moments)
library(EnvStats)
```


```{r}
# Carga de los datos
datos <- read_excel("../Datos/Trabajo Final 2024 Base de Datos .xlsx")
cer <- read_excel("../Datos/CER.xlsx")

datos$Fecha <- lubridate::as_date(datos$Fecha)
cer$Fecha <- lubridate::as_date(cer$Fecha)

datos$Fecha[1] + lubridate::days(45)
cer$Fecha[354] + days(45)
```


```{r}
limite = cer$CER[cer$Fecha == (datos$Fecha[3431] + days(45))] 


cer$CER[cer$Fecha == (datos$Fecha[1:3] + days(45))]
```

```{r}
# Ajuste por el indice CER a 45 dias
indice = numeric(nrow(datos))
for (i in 1:nrow(datos)) {
  indice[i] <- cer$CER[cer$Fecha == (datos$Fecha[i] + days(45))]
}

datos$Cuantia_ajust <- datos$Cuantía * limite/indice
```

## Analisis descriptivo

```{r}
cuantia_total <- sum(datos$Cuantia_ajust)
```
```{r}
datos |> 
  mutate(mes = factor(month(Fecha))) |> 
  ggplot() +
  aes(x = mes, y = Cuantia_ajust/1000000) +
  geom_bar(stat = "identity") +
  theme_bw() +
  labs(y = "Cuantia", 
       caption = "* los valores estan expresados en millones de pesos (ej:150 son 150 millones)",
       x = "Mes")
```
```{r}
datos |> 
  mutate(mes = factor(month(Fecha))) |>
  group_by(mes) |> 
  summarize(siniestros = n(),
            total_cuantia = sum(Cuantia_ajust)) |> 
  ggplot() +
  aes(x = mes, y = siniestros) +
  geom_bar(stat = "identity") +
  theme_bw()
```
```{r}
# Medidas resumenes de las cuantias
media_datos = mean(datos$Cuantia_ajust) # Promedio
var_datos = var(datos$Cuantia_ajust) # Desvío estandar
asimetria_datos = skewness(datos$Cuantia_ajust) # Coeficiente de asimetría

# Medidas resumenes de los siniestros
siniestros_datos <- datos |> 
  mutate(mes = factor(month(Fecha))) |>
  group_by(mes) |> 
  summarize(siniestros = n(),
            total_cuantia = sum(Cuantia_ajust))
media_siniestros = mean(siniestros_datos$siniestros)
var_siniestros = var(siniestros_datos$siniestros)
```

## Propuesta 1

- Distribución de los siniestros: Binomial negativa
- Distribución de la cuantías: Log-Normal
- Recargos de seguridad: 2% y 5%


```{r}
mean(c(3023, 3581, 3431))
var(c(3023, 3581, 3431)) # Necesario para obtener los parametros de la binomial negativa
siniestros_prop1 <- rnbinom(10000, 140, 0.04) # r = 140 - p = 0.04
```

```{r}
mom1 <- media_datos
mom2 <- var_datos + mom1^2

r <- mom2/(mom1^2)

sigma_est <- sqrt(log(r))
mu_est <- log(mom1) - (1/2)*log(r)

media_siniestros_simulados1 <- mean(siniestros_prop1)
var_siniestros_simulados1 <- var(siniestros_prop1)

cuantia_total_simulada <- numeric(length(siniestros_prop1))
esperanzas_simuladas <- numeric(length(siniestros_prop1))
variancias_simuladas <- numeric(length(siniestros_prop1))
coef_asimetria_simuladas <- numeric(length(siniestros_prop1))
contador <- 0

for(i in siniestros_prop1){
  contador <- contador + 1
  pos <- rlnorm(n = i, meanlog = mu_est, sdlog = sigma_est)
  esperanzas_simuladas[contador] <- mean(pos)
  variancias_simuladas[contador] <- var(pos)
  coef_asimetria_simuladas[contador] <- skewness(pos)
  cuantia_total_simulada[contador] <- sum(pos)
}

media_ej1 <- mean(esperanzas_simuladas) # Esperanza del ejercicio
var_ej1 <- mean(variancias_simuladas) # Variancia del ejercicio
coef_as_ej1 <- mean(coef_asimetria_simuladas)

media_cuantia_total <- media_ej1 * media_siniestros_simulados1
```
## Propuesta 2

- Distribución de los siniestros: Binomial negativa
- Distribución de la cuantías: Pareto I
- Recargos de seguridad: 2% y 5%

```{r}
theta = (nrow(datos)*media_datos - min(datos$Cuantia_ajust))/(nrow(datos)*(media_datos - min(datos$Cuantia_ajust)))
eta = (nrow(datos)*theta-1)*min(datos$Cuantia_ajust)/(nrow(datos)*theta)

cuantia_total_simulada2 <- numeric(length(siniestros_prop1))
esperanzas_simuladas2 <- numeric(length(siniestros_prop1))
variancias_simuladas2 <- numeric(length(siniestros_prop1))
coef_asimetria_simuladas2 <- numeric(length(siniestros_prop1))
contador <- 0

for(i in siniestros_prop1){
  contador <- contador + 1
  pos <- rpareto(n = i, location = eta, shape = theta)
  esperanzas_simuladas2[contador] <- mean(pos)
  variancias_simuladas2[contador] <- var(pos)
  coef_asimetria_simuladas2[contador] <- skewness(pos)
  cuantia_total_simulada2[contador] <- sum(pos)
}

media_ej2 <- mean(esperanzas_simuladas2) # Esperanza del ejercicio
var_ej2 <- mean(variancias_simuladas2) # Variancia del ejercicio
coef_as_ej2 <- mean(coef_asimetria_simuladas2)

media_cuantia_total2 <- media_ej2 * media_siniestros_simulados1
```

## Propuesta 3

- Distribución de los siniestros: Binomial negativa
- Distribución de la cuantías: Gamma
- Recargos de seguridad: 2% y 5%

```{r}
alpha = (media_datos^2)/(var_datos)
beta = var_datos/media_datos

cuantia_total_simulada3 <- numeric(length(siniestros_prop1))
esperanzas_simuladas3 <- numeric(length(siniestros_prop1))
variancias_simuladas3 <- numeric(length(siniestros_prop1))
coef_asimetria_simuladas3 <- numeric(length(siniestros_prop1))
contador <- 0

for(i in siniestros_prop1){
  contador <- contador + 1
  pos <- rgamma(n = i, shape = alpha, scale = beta)
  esperanzas_simuladas3[contador] <- mean(pos)
  variancias_simuladas3[contador] <- var(pos)
  coef_asimetria_simuladas3[contador] <- skewness(pos)
  cuantia_total_simulada3[contador] <- sum(pos)
}

media_ej3 <- mean(esperanzas_simuladas3) # Esperanza del ejercicio
var_ej3 <- mean(variancias_simuladas3) # Variancia del ejercicio
coef_as_ej3 <- mean(coef_asimetria_simuladas3)

media_cuantia_total3 <- media_ej3 * media_siniestros_simulados1
```


